<mxfile host="app.diagrams.net" modified="2026-02-06T04:17:00.000Z" agent="Cascade" version="21.0.0">
  <diagram id="rssi-architecture" name="RSSI Filter Architecture">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="KW47 Keyless Entry — RSSI Filtering Architecture (Q4 Pipeline)" style="text;html=1;fontSize=20;fontStyle=1;align=center;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="400" y="15" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- ========== HARDWARE LAYER ========== -->
        <mxCell id="hw_group" value="Hardware Layer" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="300" height="200" as="geometry" />
        </mxCell>
        <mxCell id="kw47" value="KW47B42ZB7 MCU&#xa;(Cortex-M33)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;fontStyle=1;" vertex="1" parent="hw_group">
          <mxGeometry x="20" y="40" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="ble_radio" value="BLE 6.0 Radio&#xa;+ Antenna" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" vertex="1" parent="hw_group">
          <mxGeometry x="20" y="110" width="120" height="50" as="geometry" />
        </mxCell>
        <mxCell id="serial" value="USB Serial&#xa;(VCOM)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" vertex="1" parent="hw_group">
          <mxGeometry x="160" y="110" width="120" height="50" as="geometry" />
        </mxCell>

        <!-- ========== PHONE ========== -->
        <mxCell id="phone" value="iPhone&#xa;(nRF Connect)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=13;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="340" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ble_arrow" value="BLE Connection&#xa;(RSSI)" style="endArrow=classic;startArrow=classic;html=1;fontSize=11;strokeWidth=2;strokeColor=#9673a6;" edge="1" parent="1" source="phone" target="ble_radio">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ========== PC ========== -->
        <mxCell id="pc" value="PC Terminal&#xa;(screen 115200)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="340" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="serial_arrow" value="Serial&#xa;Diagnostics" style="endArrow=classic;startArrow=classic;html=1;fontSize=11;strokeWidth=2;strokeColor=#d6b656;" edge="1" parent="1" source="pc" target="serial">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ========== BLE STACK LAYER ========== -->
        <mxCell id="ble_group" value="BLE Stack (NXP SDK)" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="80" width="280" height="130" as="geometry" />
        </mxCell>
        <mxCell id="gap" value="GAP Interface&#xa;Gap_ReadRssi()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;" vertex="1" parent="ble_group">
          <mxGeometry x="20" y="40" width="140" height="50" as="geometry" />
        </mxCell>
        <mxCell id="conn_cb" value="Connection Callback&#xa;gConnEvtRssiRead_c" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="ble_group">
          <mxGeometry x="20" y="60" width="240" height="50" as="geometry" />
        </mxCell>

        <!-- ========== APPLICATION LAYER ========== -->
        <mxCell id="app_group" value="Application Layer" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#d5e8d4;strokeColor=#82b366;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="240" width="280" height="180" as="geometry" />
        </mxCell>
        <mxCell id="dk_app" value="digital_key_car_anchor_cs.c&#xa;BleApp_ConnectionCallback()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="app_group">
          <mxGeometry x="20" y="40" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="shell_cmd" value="shell_digital_key_car_anchor_cs.c&#xa;rssi / rssistop commands" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="app_group">
          <mxGeometry x="20" y="110" width="240" height="50" as="geometry" />
        </mxCell>

        <!-- ========== RSSI INTEGRATION LAYER ========== -->
        <mxCell id="integration_group" value="RSSI Integration Layer" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="740" y="80" width="280" height="170" as="geometry" />
        </mxCell>
        <mxCell id="rssi_int" value="rssi_integration.c&#xa;&#xa;• Init / Connect / Disconnect&#xa;• UpdateRssi() → AddMeasurement()&#xa;• Diagnostics (every 5 samples)&#xa;• Event-based state change print" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;spacingLeft=10;" vertex="1" parent="integration_group">
          <mxGeometry x="20" y="40" width="240" height="110" as="geometry" />
        </mxCell>

        <!-- ========== RSSI FILTER MODULE ========== -->
        <mxCell id="filter_group" value="RSSI Filter Module (rssi_filter.c)" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="740" y="290" width="280" height="370" as="geometry" />
        </mxCell>

        <!-- Stage 1: Hampel -->
        <mxCell id="hampel" value="Stage 1: Hampel Filter&#xa;Outlier rejection via Median + MAD&#xa;Window: 800ms, K=3.0" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;fontStyle=0;align=left;spacingLeft=8;" vertex="1" parent="filter_group">
          <mxGeometry x="20" y="40" width="240" height="55" as="geometry" />
        </mxCell>

        <!-- Stage 2: EMA -->
        <mxCell id="ema" value="Stage 2: Adaptive EMA&#xa;Time-scaled alpha (Q15)&#xa;Alpha: 0.10–0.80, Anomaly reset &gt;2s" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;fontStyle=0;align=left;spacingLeft=8;" vertex="1" parent="filter_group">
          <mxGeometry x="20" y="110" width="240" height="55" as="geometry" />
        </mxCell>

        <!-- Stage 3: Features -->
        <mxCell id="features" value="Stage 3: Feature Extraction&#xa;2s window: StdDev(Q4), PctAbove(Q15)&#xa;Min, Max, Mean" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;fontStyle=0;align=left;spacingLeft=8;" vertex="1" parent="filter_group">
          <mxGeometry x="20" y="180" width="240" height="55" as="geometry" />
        </mxCell>

        <!-- Stage 4: State Machine -->
        <mxCell id="state_machine" value="Stage 4: State Machine&#xa;&#xa;IDLE → FAR (first sample)&#xa;FAR → CANDIDATE (≥ -60 dBm)&#xa;CANDIDATE → UNLOCK (stable 2s)&#xa;  Exit confirm: 1.5s &lt; -70 dBm&#xa;  Post-unlock lockout: 5s" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="filter_group">
          <mxGeometry x="20" y="250" width="240" height="105" as="geometry" />
        </mxCell>

        <!-- Filter internal arrows -->
        <mxCell id="f_flow1" value="clean Q4" style="endArrow=classic;html=1;fontSize=10;strokeWidth=1;dashed=1;" edge="1" parent="1" source="hampel" target="ema">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="f_flow2" value="smoothed Q4" style="endArrow=classic;html=1;fontSize=10;strokeWidth=1;dashed=1;" edge="1" parent="1" source="ema" target="features">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="f_flow3" value="features" style="endArrow=classic;html=1;fontSize=10;strokeWidth=1;dashed=1;" edge="1" parent="1" source="features" target="state_machine">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ========== PROXIMITY STATE MACHINE ========== -->
        <mxCell id="prox_group" value="Proximity State Machine" style="swimlane;startSize=30;fontSize=14;fontStyle=1;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1100" y="290" width="280" height="280" as="geometry" />
        </mxCell>
        <mxCell id="prox_states" value="States:&#xa;&#xa;• Disconnected&#xa;• Monitoring&#xa;• Approach&#xa;• Ranging (future CS)&#xa;• Proximity&#xa;• Unlock&#xa;• Locked" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;align=left;spacingLeft=10;" vertex="1" parent="prox_group">
          <mxGeometry x="20" y="40" width="240" height="170" as="geometry" />
        </mxCell>
        <mxCell id="unlock_output" value="UNLOCK&#xa;CONDITION" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#60a917;fontColor=#ffffff;strokeColor=#2D7600;fontSize=13;fontStyle=1;" vertex="1" parent="prox_group">
          <mxGeometry x="60" y="225" width="160" height="40" as="geometry" />
        </mxCell>

        <!-- ========== UNIT TESTS ========== -->
        <mxCell id="test_group" value="Unit Tests (Host)" style="swimlane;startSize=25;fontSize=12;fontStyle=1;fillColor=#f0f0f0;strokeColor=#999999;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1100" y="610" width="280" height="100" as="geometry" />
        </mxCell>
        <mxCell id="tests" value="test_rssi_filter.c&#xa;25 tests | JUnit XML | Log file&#xa;Mocks: EmbeddedTypes, TimerMgr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="test_group">
          <mxGeometry x="20" y="30" width="240" height="55" as="geometry" />
        </mxCell>

        <!-- Test -> Filter (dashed) -->
        <mxCell id="test_arrow" value="tests" style="endArrow=classic;html=1;fontSize=10;strokeWidth=1;dashed=1;strokeColor=#999999;" edge="1" parent="1" source="tests" target="filter_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ========== ARROWS / DATA FLOW ========== -->
        <!-- BLE Stack -> App -->
        <mxCell id="flow1" value="RSSI event" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;entryX=0.5;entryY=0;exitX=0.5;exitY=1;" edge="1" parent="1" source="ble_group" target="app_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- App -> Integration -->
        <mxCell id="flow2" value="UpdateRssi(id, rssi)" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;" edge="1" parent="1" source="dk_app" target="rssi_int">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Shell -> Integration -->
        <mxCell id="flow3" value="Start/Stop" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;dashed=1;" edge="1" parent="1" source="shell_cmd" target="rssi_int">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Integration -> Filter -->
        <mxCell id="flow4" value="Raw RSSI (dBm)" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;" edge="1" parent="1" source="rssi_int" target="filter_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Filter -> Proximity SM -->
        <mxCell id="flow7" value="State + Event&#xa;+ Filtered RSSI" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;" edge="1" parent="1" source="filter_group" target="prox_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Integration -> GAP (timer triggers read) -->
        <mxCell id="flow8" value="Gap_ReadRssi()&#xa;(~100ms polling)" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;dashed=1;strokeColor=#b85450;" edge="1" parent="1" source="rssi_int" target="gap">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- HW -> BLE Stack -->
        <mxCell id="flow9" value="" style="endArrow=classic;html=1;fontSize=11;strokeWidth=2;" edge="1" parent="1" source="kw47" target="ble_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="Legend" style="swimlane;startSize=25;fontSize=12;fontStyle=1;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1100" y="80" width="280" height="170" as="geometry" />
        </mxCell>
        <mxCell id="leg1" value="Hardware" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="10" y="30" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg2" value="BLE Stack" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="100" y="30" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg3" value="Application" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="10" y="65" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg4" value="Integration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="100" y="65" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg5" value="Filter (Q4)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="10" y="100" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg6" value="Prox SM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="100" y="100" width="80" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg7" value="── Data flow&#xa;- - Command/trigger" style="text;html=1;fontSize=10;align=left;" vertex="1" parent="legend">
          <mxGeometry x="10" y="130" width="160" height="30" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
